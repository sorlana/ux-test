name: ðŸš€ Deploy to Beget

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: ðŸ”§ Install lftp
      run: sudo apt-get update && sudo apt-get install -y lftp
      
    - name: ðŸ“‚ Upload with retries
      run: |
        MAX_RETRIES=3
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Attempt $((RETRY_COUNT+1)) of $MAX_RETRIES"
          
          lftp -e "
            set ftp:ssl-force true;
            set ssl:verify-certificate false;
            set net:timeout 60;
            set net:max-retries 3;
            set net:reconnect-interval-base 10;
            open -u ${{ secrets.FTP_USERNAME }},${{ secrets.FTP_PASSWORD }} ${{ secrets.FTP_SERVER }};
            mkdir -p ux-test;
            cd ux-test;
            mirror -R -v -P 2 . ./;
            quit
          " && break
          
          RETRY_COUNT=$((RETRY_COUNT+1))
          if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo "Upload failed. Retrying in 15 seconds..."
            sleep 15
          else
            echo "Upload failed after $MAX_RETRIES attempts."
            exit 1
          fi
        done
